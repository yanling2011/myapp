/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 2 21:01
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(k,s,t,r){s=r.create(t.Controller,[r.Box],{initializer:function(){var k;this.__commands={};this.__dialogs={};if(k=this.get("textarea")){if(!this.get("render")&&!this.get("elBefore")){var n=k.next();n?this.__set("elBefore",n):this.__set("render",k.parent())}this.get("width")||this.__set("width",k.style("width")||k.css("width"));this.get("height")||this.__set("height",k.style("height")||k.css("height"))}else this.__editor_created_new=1},use:function(j,n){for(var p=
this,o=p.__CORE_PLUGINS||["htmlDataProcessor","enterKey","clipboard","selection"],j=j.split(","),a=j.length-1;0<=a;a--)j[a]||j.splice(a,1);for(a=0;a<o.length;a++){var e=o[a];k.inArray(e,j)||j.unshift(e)}k.each(j,function(a,e){j[e]&&(j[e]="editor/plugin/"+a+"/")});k.use(j.join(","),function(){var a=k.makeArray(arguments);a.shift();for(var e=0;e<a.length;e++)a[e].init(p);n&&n.call(p)});p.__CORE_PLUGINS=[];return p}},{Config:{base:k.Config.base+"editor/"},XHTML_DTD:s.DTD,ATTRS:{textarea:{},iframe:{},
window:{},document:{},iframeWrapEl:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(k){return this._setData(k)}},formatData:{getter:function(){return this._getData(1)},setter:function(k){return this._setData(k)}},prefixCls:{value:"ke-"}}},"Editor");s.DefaultRender=r.create(t.Render,[r.Box.Render],{_uiSetHeight:function(){}});k.mix(s,k.EventTarget);return KISSY.Editor=s},{requires:["htmlparser",
"component","uibase","core"]});
KISSY.add("editor/plugin/clipboard/index",function(k){function s(i){this.editor=i;this._init()}function t(i){if(n.ie&&"BackCompat"!=i.get("document")[0].compatMode){var l=i.getSelection(),f;if(l.getType()==x.SELECTION_ELEMENT&&(f=l.getSelectedElement())){var b=l.getRanges()[0],g=new j(i.get("document")[0].createTextNode(""));g.insertBefore(f);b.setStartBefore(g);b.setEndAfter(f);l.selectRanges([b]);setTimeout(function(){f.parent()&&(g.remove(),l.selectElement(f))},0)}}}var r=k.Editor,j=k.Node,n=k.UA,
p=r.Range,o=r.RANGE,a=k.Event;k.augment(s,{_init:function(){var i=this.editor;a.on(i.get("document")[0].body,n.webkit?"paste":n.gecko?"paste":"beforepaste",this._paste,this);a.on(i.get("document")[0].body,"contextmenu",function(){l=1;setTimeout(function(){l=0},10)});i.addCommand("copy",new m("copy"));i.addCommand("cut",new m("cut"));i.addCommand("paste",new m("paste"))},_paste:function(){if(!l){var i=this.editor,a=i.get("document")[0];if(!a.getElementById("ke_pastebin")){var f=i.getSelection(),b=
new p(a),g=new j(n.webkit?"<body></body>":"<div></div>",null,a);g.attr("id","ke_pastebin");n.webkit&&g[0].appendChild(a.createTextNode("\u00a0"));a.body.appendChild(g[0]);g.css({position:"absolute",top:f.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});g.css("left","-1000px");var c=f.createBookmarks();b.setStartAt(g,o.POSITION_AFTER_START);b.setEndAt(g,o.POSITION_BEFORE_END);b.select(!0);setTimeout(function(){g.remove();var b;g=n.webkit&&(b=g.first())&&b.hasClass("Apple-style-span")?
b:g;f.selectBookmarks(c);b=g.html();if(b=k.trim(b.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var l=i.fire("paste",{html:b,holder:g});void 0!==l&&(b=l);l=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(b)&&(l=i.htmlDataProcessor.wordFilter);i.insertHtml(b,l)}},0)}}}});var e=function(i,l){var f=i.get("document")[0],b=new j(f.body),g=!1,c=function(){g=!0};b.on(l,c);(7<n.ie?f:f.selection.createRange()).execCommand(l);b.detach(l,c);return g},h=n.ie?function(i,l){return e(i,
l)}:function(i,l){try{return i.get("document")[0].execCommand(l)}catch(f){return!1}},d={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},m=function(i){this.type=i};m.prototype={exec:function(i){"cut"==this.type&&t(i);(i=h(i,this.type))||alert(d[this.type]);return i}};var x=r.Selection,i={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},l;r.on("contextmenu",function(l){var a=l.contextmenu,f=a.get("editor"),
b=a.menu.get("contentEl"),g={copy:0,cut:0,paste:0},c;for(c in g)g.hasOwnProperty(c)&&(g[c]=b.one(".ke-paste-"+c),g[c]||function(c){var l=(new j("<a href='#'class='ke-paste-"+c+"'>"+i[c]+"</a>")).appendTo(b);l.on("click",function(b){b.halt();a.hide();setTimeout(function(){f.execCommand(c)},30)});g[c]=l}(c))});return{init:function(i){i.docReady(function(){new s(i)})}}},{requires:["editor"]});
KISSY.add("editor/core/dom",function(k){function s(i,l){var a=i[l?"next":"prev"]();if(a&&a[0].nodeType==e.NODE_ELEMENT){for(var d=[];a.attr("_ke_bookmark")||a._4e_isEmptyInlineRemovable(t);)if(d.push(a),a=l?a.next():a.prev(),!a)return;if(i._4e_isIdentical(a,t)){for(var f=new p(l?i[0].lastChild:i[0].firstChild);d.length;)d.shift()._4e_move(i,!l,t);a._4e_moveChildren(i,!l,t);a.remove();f[0]&&f[0].nodeType==e.NODE_ELEMENT&&f._4e_mergeSiblings()}}}var t=t,r=k.Editor,j=k.DOM,n=k.UA,p=k.Node,o=r.Utils,
a={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};r.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};r.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var e=r.NODE,h=r.POSITION,d={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,
"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},m={hr:1},x=function(i){return i&&(i[0]||i)};o.injectDom({_4e_isBlockBoundary:function(i,l){var a=k.merge(m,l);return!(!d[j.css(i,"display")]&&!a[j._4e_name(i)])},_4e_getWin:j._getWin,_4e_index:function(i,l){for(var a=i.parentNode.childNodes,e,f=-1,b=0;b<a.length;b++)if(e=a[b],!l||!(3==e.nodeType&&e.previousSibling&&3==e.previousSibling.nodeType))if(f++,e===i)return f;return-1},_4e_move:function(i,
l,a){l=x(l);a?l.insertBefore(i,l.firstChild):l.appendChild(i)},_4e_name:function(i){var l=i.nodeName.toLowerCase();n.ie&&(i=i.scopeName)&&"HTML"!=i&&(l=i.toLowerCase()+":"+l);return l},_4e_isIdentical:function(i,l){if(!l)return!1;l=x(l);if(j._4e_name(i)!=j._4e_name(l))return!1;var a=i.attributes,e=l.attributes,f=a.length,b=e.length;if(f!=b)return!1;for(var g=0;g<f;g++){var c=a[g],v=c.name;if(c.specified&&j.attr(i,v)!=j.attr(l,v))return!1}if(8>o.ieEngine)for(g=0;g<b;g++)if(c=e[g],v=c.name,c.specified&&
j.attr(i,v)!=j.attr(l,v))return!1;return!0},_4e_isEmptyInlineRemovable:function(i){for(var i=i.childNodes,l=0,a=i.length;l<a;l++){var d=i[l],f=d.nodeType;if(!(f==e.NODE_ELEMENT&&d.getAttribute("_ke_bookmark"))&&(f==e.NODE_ELEMENT&&!j._4e_isEmptyInlineRemovable(d)||f==e.NODE_TEXT&&k.trim(d.nodeValue)))return!1}return!0},_4e_moveChildren:function(i,a,e){a=x(a);if(i!=a)if(e)for(;e=i.lastChild;)a.insertBefore(i.removeChild(e),a.firstChild);else for(;e=i.firstChild;)a.appendChild(i.removeChild(e))},_4e_mergeSiblings:function(i){i=
new p(i);a[i._4e_name()]&&(s(i,!0),s(i))},_4e_splitText:function(i,a){var d=i.ownerDocument;if(i.nodeType==e.NODE_TEXT){if(n.ie&&a==i.nodeValue.length){var h=d.createTextNode("");j.insertAfter(h,i);return h}h=i.splitText(a);d.documentMode&&(d=d.createTextNode(""),j.insertAfter(d,h),j.remove(d));return h}},_4e_parents:function(i,a){var e=[];e.__IS_NODELIST=1;do e[a?"push":"unshift"](i);while(i=i.parentNode);return e},_4e_nextSourceNode:function(i,a,d,h){if(h&&!h.call)var f=x(h),h=function(b){return b!==
f};var a=!a&&i.firstChild,b=i;if(!a){if(i.nodeType==e.NODE_ELEMENT&&h&&!1===h(i,!0))return null;a=i.nextSibling}for(;!a&&(b=b.parentNode);){if(h&&!1===h(b,!0))return null;a=b.nextSibling}return!a||h&&!1===h(a)?null:d&&d!=a.nodeType?j._4e_nextSourceNode(a,!1,d,h):a},_4e_previousSourceNode:function(i,a,d,h){if(h&&!h.call)var f=x(h),h=function(b){return b!==f};var a=!a&&i.lastChild,b=i;if(!a){if(i.nodeType==e.NODE_ELEMENT&&h&&!1===h(i,!0))return null;a=i.previousSibling}for(;!a&&(b=b.parentNode);){if(h&&
!1===h(b,!0))return null;a=b.previousSibling}return!a||h&&!1===h(a)?null:d&&a.nodeType!=d?j._4e_previousSourceNode(a,!1,d,h):a},_4e_commonAncestor:function(i,a){a=x(a);if(i===a)return i;if(j.contains(a,i))return a;var e=i;do if(j.contains(e,a))return e;while(e=e.parentNode);return null},_4e_hasAttributes:9>o.ieEngine?function(a){for(var e=a.attributes,d=0;d<e.length;d++){var h=e[d];switch(h.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(h.specified)return!0}}return!1}:function(a){n.gecko&&
a.removeAttribute("_moz_dirty");return a.hasAttributes()},_4e_position:function(a,l){var d=x(l);if(a.compareDocumentPosition)return a.compareDocumentPosition(d);if(a==d)return h.POSITION_IDENTICAL;if(a.nodeType==e.NODE_ELEMENT&&d.nodeType==e.NODE_ELEMENT){if(j.contains(a,d))return h.POSITION_CONTAINS+h.POSITION_PRECEDING;if(j.contains(d,a))return h.POSITION_IS_CONTAINED+h.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>d.sourceIndex?h.POSITION_DISCONNECTED:a.sourceIndex<d.sourceIndex?
h.POSITION_PRECEDING:h.POSITION_FOLLOWING}for(var m=j._4e_address(a),d=j._4e_address(d),f=Math.min(m.length,d.length),b=0;b<=f-1;b++)if(m[b]!=d[b])return m[b]<d[b]?h.POSITION_PRECEDING:h.POSITION_FOLLOWING;return m.length<d.length?h.POSITION_CONTAINS+h.POSITION_PRECEDING:h.POSITION_IS_CONTAINED+h.POSITION_FOLLOWING},_4e_address:function(a,e){for(var d=[],h=a.ownerDocument.documentElement,f=a;f&&f!=h;)d.unshift(j._4e_index(f,e)),f=f.parentNode;return d},_4e_remove:function(a,e){var d=a.parentNode;
if(d){if(e)for(var h;h=a.firstChild;)d.insertBefore(a.removeChild(h),a);d.removeChild(a)}return a},_4e_trim:function(a){j._4e_ltrim(a);j._4e_rtrim(a)},_4e_ltrim:function(a){for(var d;d=a.firstChild;){if(d.nodeType==e.NODE_TEXT){var h=o.ltrim(d.nodeValue),m=d.nodeValue.length;if(h)h.length<m&&(j._4e_splitText(d,m-h.length),a.removeChild(a.firstChild));else{a.removeChild(d);continue}}break}},_4e_rtrim:function(a){for(var d;d=a.lastChild;){if(d.type==e.NODE_TEXT){var h=o.rtrim(d.nodeValue),m=d.nodeValue.length;
if(h)h.length<m&&(j._4e_splitText(d,h.length),a.removeChild(a.lastChild));else{a.removeChild(d);continue}}break}!n.ie&&!n.opera&&(d=a.lastChild)&&1==d.nodeType&&"br"==j._4e_name(d)&&a.removeChild(d)},_4e_appendBogus:function(a){for(var d=a.lastChild;d&&d.nodeType==e.NODE_TEXT&&!k.trim(d.nodeValue);)d=d.previousSibling;if(!d||d.nodeType==e.NODE_TEXT||"br"!==j._4e_name(d))d=n.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br"),n.gecko&&d.setAttribute("type","_moz"),a.appendChild(d)},
_4e_outerHtml:function(a){if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var d=a.ownerDocument.createElement("div");d.appendChild(a.cloneNode(!0));return d.innerHTML},_4e_setMarker:function(a,d,e,h){var a=new p(a),f=a.data("list_marker_id")||a.data("list_marker_id",k.guid()).data("list_marker_id"),b=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");d[f]=a;b[e]=1;return a.data(e,h)},_4e_clearMarkers:function(a,d,e){var a=new p(a),h=a.data("list_marker_names"),
f=a.data("list_marker_id"),b;for(b in h)h.hasOwnProperty(b)&&a.removeData(b);a.removeData("list_marker_names");e&&(a.removeData("list_marker_id"),delete d[f])},_4e_copyAttributes:function(a,d,e){for(var d=new p(d),h=a.attributes,e=e||{},f=0;f<h.length;f++){var b=h[f],g=b.name.toLowerCase(),c;if(!(g in e))if("checked"==g&&(c=j.attr(a,g)))d.attr(g,c);else if(b.specified||n.ie&&b.value&&"value"==g)c=j.attr(a,g),null===c&&(c=b.nodeValue),d.attr(g,c)}""!==a.style.cssText&&(d[0].style.cssText=a.style.cssText)},
_4e_isEditable:function(a){var a=j._4e_name(a),d=r.XHTML_DTD;return(a=!d.$nonEditable[a]&&(d[a]||d.span))&&a["#"]}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(k){function s(a){1>arguments.length||(this.range=a,this.forceBrBreak=r,this.enlargeBr=t,this.enforceRealBlocks=r,this._||(this._={}))}var t=!0,r=!1,j=k.Editor,n=k.UA,p=j.Walker,o=j.Range,a=j.RANGE,e=j.NODE,h=j.ElementPath,d=k.Node,m=k.DOM,x=/^[\r\n\t ]*$/;k.augment(s,{getNextParagraph:function(i){var l,j,w,f,b;if(!this._.lastNode){j=this.range.clone();j.shrink(a.SHRINK_ELEMENT,t);j.enlarge(this.forceBrBreak||!this.enlargeBr?a.ENLARGE_LIST_ITEM_CONTENTS:
a.ENLARGE_BLOCK_CONTENTS);var g=new p(j),c=p.bookmark(t,t);g.evaluator=c;this._.nextNode=g.next();g=new p(j);g.evaluator=c;g=g.previous();this._.lastNode=g._4e_nextSourceNode(t);this._.lastNode&&this._.lastNode[0].nodeType==e.NODE_TEXT&&!k.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(c=new o(j.document),c.moveToPosition(this._.lastNode,a.POSITION_AFTER_END),c.checkEndOfBlock()&&(c=new h(c.endContainer),this._.lastNode=(c.block||c.blockLimit)._4e_nextSourceNode(t)));
this._.lastNode||(this._.lastNode=this._.docEndMarker=new d(j.document.createTextNode("")),m.insertAfter(this._.lastNode[0],g[0]));j=null}c=this._.nextNode;g=this._.lastNode;for(this._.nextNode=null;c;){var v=r,u=c[0].nodeType!=e.NODE_ELEMENT,q=r;if(u)c[0].nodeType==e.NODE_TEXT&&x.test(c[0].nodeValue)&&(u=r);else{var z=c._4e_name();if(c._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==z)u=t;else if(!j&&!c[0].childNodes.length&&"hr"!=z){l=c;w=c.equals(g);break}j&&(j.setEndAt(c,a.POSITION_BEFORE_START),
"br"!=z&&(this._.nextNode=c));v=t}else{if(c[0].firstChild){j||(j=new o(this.range.document),j.setStartAt(c,a.POSITION_BEFORE_START));c=new d(c[0].firstChild);continue}u=t}}u&&!j&&(j=new o(this.range.document),j.setStartAt(c,a.POSITION_BEFORE_START));w=(!v||u)&&c.equals(g);if(j&&!v)for(;!c[0].nextSibling&&!w;){z=c.parent();if(z._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){v=t;w||z.equals(g);break}c=z;u=t;w=c.equals(g);q=t}u&&j.setEndAt(c,a.POSITION_AFTER_END);c=c._4e_nextSourceNode(q,null,g);if((w=
!c)||v&&j)break}if(!l){if(!j)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;l=new h(j.startContainer);c=l.blockLimit;v={div:1,th:1,td:1};l=l.block;if((!l||!l[0])&&!this.enforceRealBlocks&&v[c._4e_name()]&&j.checkStartOfBlock()&&j.checkEndOfBlock())l=c;else if(!l||this.enforceRealBlocks&&"li"==l._4e_name())l=new d(this.range.document.createElement(i||"p")),l[0].appendChild(j.extractContents()),l._4e_trim(),j.insertNode(l),f=b=t;else if("li"!=l._4e_name()){if(!j.checkStartOfBlock()||
!j.checkEndOfBlock())l=l.clone(r),l[0].appendChild(j.extractContents()),l._4e_trim(),b=j.splitBlock(),f=!b.wasStartOfBlock,b=!b.wasEndOfBlock,j.insertNode(l)}else w||(this._.nextNode=l.equals(g)?null:j.getBoundaryNodes().endNode._4e_nextSourceNode(t,null,g))}f&&(j=new d(l[0].previousSibling),j[0]&&j[0].nodeType==e.NODE_ELEMENT&&("br"==j._4e_name()?j._4e_remove():j[0].lastChild&&"br"==m._4e_name(j[0].lastChild)&&m._4e_remove(j[0].lastChild)));b&&(j=p.bookmark(r,t),f=new d(l[0].lastChild),f[0]&&f[0].nodeType==
e.NODE_ELEMENT&&"br"==f._4e_name()&&(n.ie||f.prev(j)||f.next(j))&&f.remove());this._.nextNode||(this._.nextNode=w||l.equals(g)?null:l._4e_nextSourceNode(t,null,g));return l}});o.prototype.createIterator=function(){return new s(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(k){function s(e){for(var h=p,d=p,m=[];e;){if(e[0].nodeType==n.NODE_ELEMENT){this.lastElement||(this.lastElement=e);var k=e._4e_name();if(!d&&(!h&&o[k]&&(h=e),a[k])){var i;if(i=!h)if(i="div"==k){a:{i=e[0].childNodes;for(var l=0,s=i.length;l<s;l++){var w=i[l];if(w.nodeType==n.NODE_ELEMENT&&j.$block[w.nodeName.toLowerCase()]){i=!0;break a}}i=!1}i=!i}i?h=e:d=e}m.push(e);if("body"==k)break}e=e.parent()}this.block=h;this.blockLimit=d;this.elements=m}var t=k.Editor,
r=k.DOM,j=t.XHTML_DTD,n=t.NODE,p=null,o={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},a={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};s.prototype={compare:function(a){var h=this.elements,a=a&&a.elements;if(!a||h.length!=a.length)return!1;for(var d=0;d<h.length;d++)if(!r.equals(h[d],a[d]))return!1;return!0},contains:function(a){for(var h=this.elements,d=0;d<h.length;d++)if(h[d]._4e_name()in a)return h[d];return p},toString:function(){var a=this.elements,
h,d=[];for(h=0;h<a.length;h++)d.push(a[h]._4e_name());return d.toString()}};t.ElementPath=s},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/enterKey/index",function(k){function s(a){var m;m=a.getSelection().getRanges();for(var s=m.length-1;0<s;s--)m[s].deleteContents();m=m[0];s=m.document;if(m.checkStartOfBlock()&&m.checkEndOfBlock()){var i=(new h(m.startContainer)).block;if(i&&("li"==i._4e_name()||"li"==i.parent()._4e_name()))return a.hasCommand("outdent")?(a.execCommand("save"),a.execCommand("outdent"),a.execCommand("save"),!0):!1}var l=m.splitBlock("p");if(!l)return!0;var a=l.previousBlock,i=l.nextBlock,r=
l.wasStartOfBlock,w=l.wasEndOfBlock,f;if(i)f=i.parent(),"li"==f._4e_name()&&(i._4e_breakParent(f),i._4e_move(i.next(),!0));else if(a&&(f=a.parent())&&"li"==f._4e_name())a._4e_breakParent(f),m.moveToElementEditablePosition(a.next()),a._4e_move(a.prev());if(!r&&!w){if("li"==i._4e_name()&&(f=i.first(e.invisible(!0)))&&k.inArray(f._4e_name(),["ul","ol"]))(j.ie?new o(s.createTextNode("\u00a0")):new o(s.createElement("br"))).insertBefore(f);i&&m.moveToElementEditablePosition(i)}else{var b;if(a){if("li"==a._4e_name()||
!n.test(a._4e_name()))b=a.clone()}else i&&(b=i.clone());b||(b=new o("<p>",null,s));if(f=l.elementPath)for(var l=0,g=f.elements.length;l<g;l++){var c=f.elements[l];if(c.equals(f.block)||c.equals(f.blockLimit))break;p.$removeEmpty[c._4e_name()]&&(c=c.clone(),b._4e_moveChildren(c),b.append(c))}j.ie||b._4e_appendBogus();m.insertNode(b);if(j.ie&&r&&(!w||!a[0].childNodes.length))m.moveToElementEditablePosition(w?a:b),m.select();m.moveToElementEditablePosition(r&&!w?i:b)}j.ie||(i?(b=new o(s.createElement("span")),
b.html("&nbsp;"),m.insertNode(b),b.scrollIntoView(void 0,!1),m.deleteContents()):b.scrollIntoView(void 0,!1));m.select();return!0}function t(d){var e=d.get("document")[0];a.on(e,"keydown",function(a){if(13===a.keyCode&&!a.shiftKey&&!a.ctrlKey&&!a.metaKey){d.execCommand("save");var e=d.execCommand("enterBlock");d.execCommand("save");!1!==e&&a.preventDefault()}})}var r=k.Editor,j=k.UA,n=/^h[1-6]$/,p=r.XHTML_DTD,o=k.Node,a=k.Event,e=r.Walker,h=r.ElementPath;return{init:function(a){a.addCommand("enterBlock",
{exec:s});a.docReady(function(){t(a)})}}},{requires:["editor"]});
KISSY.add("editor/core/focusManager",function(k){function s(){var d=this;d.__iframeFocus=e;a=d;o&&clearTimeout(o);o=setTimeout(function(){d.fire("focus")},100)}function t(){var e=this;e.__iframeFocus=h;a=d;o&&clearTimeout(o);o=setTimeout(function(){e.fire("blur")},100)}var r=k.Editor,j=k.DOM,n=k.Event,p={},o,a,k={refreshAll:function(){for(var a in p)if(p.hasOwnProperty(a)){var d=p[a].get("document")[0];d.designMode="off";d.designMode="on"}},currentInstance:function(){return a},getInstance:function(a){return p[a]},
add:function(a){var d=j._4e_getWin(a.get("document")[0]);n.on(d,"focus",s,a);n.on(d,"blur",t,a)},register:function(a){p[a._UUID]=a},remove:function(a){delete p[a._UUID];var d=j._4e_getWin(a.get("document")[0]);n.remove(d,"focus",s,a);n.remove(d,"blur",t,a)}},e=!0,h=!1,d=null;k.refreshAll=k.refreshAll;r.focusManager=k;r.getInstances=function(){return p};return k},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/htmlDataProcessor/index",function(k){return{init:function(s){function t(a){return a.replace(x,function(a,d,b){return"<"+d+b.replace(i,function(a,c){return-1==b.indexOf("_ke_saved_"+c)?" _ke_saved_"+a+" "+a:a})+">"})}function r(a){return a.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(a){return"<\!--"+l+"{C}"+encodeURIComponent(a).replace(/--/g,"%2D%2D")+"--\>"})}function j(a){return a.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(a,d){return decodeURIComponent(d)})}
var n=n,p=k.Editor,o=k.Node,a=k.UA,e=k.require("htmlparser"),h=new e.Filter,d=new e.Filter,m=new e.Filter;(function(){var i=function(a,g){return function(c,d){var f=[];(""+c).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(z,c,e){c=c.toLowerCase();"font-family"==c&&(e=e.replace(/["']/g,""));for(var h,i,j,l=0;l<a.length;l++)if(a[l]&&(z=a[l][0],h=a[l][1],i=a[l][2],j=a[l][3],c.match(z)&&(!h||e.match(h)))){c=j||c;g&&(i=i||e);"function"==typeof i&&(i=i(e,d,c));i&&i.push&&
(c=i[0],i=i[1]);"string"==typeof i&&f.push([c,i]);return}!g&&f.push([c,e])});for(var e=0;e<f.length;e++)f[e]=f[e].join(":");return f.length?f.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],n),j={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren()},tags:{p:function(a){a.filterChildren()},$:function(a){var g=a.nodeName||"";if(-1!=g.indexOf(":")&&
!/^ke/.test(g))if("v:imagedata"==g){if(g=a.getAttribute("o:href"))a.setAttribute("src",g),a.removeAttribute("o:href");if(g=a.getAttribute("o:title"))a.setAttribute("title",g),a.removeAttribute("o:title");a.setTagName("img")}else a.setTagName("")}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(a){a=i(a);return!a?!1:a}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},f={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var g=
["name","href","src"],c,d=0;d<g.length;d++)c="_ke_saved_"+g[d],a.getAttribute(c)&&a.removeAttribute(g[d]);return a},embed:function(a){var g=a.parentNode;if(g&&"object"==g.nodeName){var c=g.getAttribute("width"),g=g.getAttribute("height");c&&a.setAttribute("width",c);g&&a.setAttribute("width",g)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1}},attributes:{style:function(a){if(!k.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,l.length)==l?(a="{C}"==a.substr(l.length,3)?a.substr(l.length+3):a.substr(l.length),new e.CData(decodeURIComponent(a))):a}};a.ie&&(f.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});h.addRules(f);d.addRules(j);m.addRules(j)})();(function(){function i(a){for(var a=a.childNodes,b=a.length,g=a[b-1];g&&3==g.nodeType&&!k.trim(g.nodeValue);)g=a[--b];return g}
function l(b,g){var z=i(b);z&&((g||!a.ie)&&1==z.nodeType&&"br"==z.nodeName?b.removeChild(z):3==z.nodeType&&c.test(z.nodeValue)&&b.removeChild(z))}function f(a){var b=i(a);return!b||1==b.nodeType&&"br"==b.nodeName||"form"==a.nodeName&&"input"==b.nodeName}function b(b){l(b,!0);f(b)&&(a.ie?b.appendChild(new e.Text("\u00a0")):(b.appendChild(new e.Text("&nbsp;")),b.appendChild(new e.Tag("br"))))}function g(a){l(a,!1);f(a)&&a.appendChild(new e.Text("\u00a0"))}var c=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,v=p.XHTML_DTD,j=p.Utils.mix({},
v.$block,v.$listItem,v.$tableContent),q;for(q in j)j.hasOwnProperty(q)&&("br"in v[q]||delete j[q]);delete j.td;delete j.pre;var v={tags:{}},z={tags:{}};for(q in j)j.hasOwnProperty(q)&&(v.tags[q]=b,z.tags[q]=g);d.addRules(v);h.addRules(z);m.addRules(v)})();(function(){h.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}})})();var x=/<(a|area|img|input)\b([^>]*)>/gi,i=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,l="{ke_protected}";s.htmlDataProcessor={wordFilter:m,
dataFilter:d,htmlFilter:h,toHtml:function(a){var d=new e.BeautifyWriter;(new e.Parser(a)).parse().writeHtml(d,h);return d.getHtml()},toDataFormat:function(i,h,f){f=f||d;a.gecko&&(i=i.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));i=t(i);h=new o("<div>");h.html("a"+i);i=h.html().substr(1);i=j(i);h=new e.BeautifyWriter;(new e.Parser(i)).parse().writeHtml(h,f);i=h.getHtml();return i=r(i)},toServer:function(a){var d=new e.MinifyWriter;(new e.Parser(a)).parse().writeHtml(d,
h);return d.getHtml()}}}}},{requires:["editor"]});KISSY.add("editor/core/meta",function(){});
KISSY.add("editor/core/range",function(k){function s(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=h;this.collapsed=a;this.document=b}function t(a){var b=a[0].nodeType!=d.NODE_TEXT&&a._4e_name()in f.$removeEmpty,g=!k.trim(a[0].nodeValue),a=!!a.parent().attr("_ke_bookmark");return b||g||a}function r(a){return!u(a)&&!q(a)}function j(b){var g=e,c=i.bookmark(a);return function(f){if(c(f))return a;if(f[0].nodeType==d.NODE_TEXT){if(k.trim(f[0].nodeValue).length)return e}else if(f[0].nodeType==
d.NODE_ELEMENT&&!v[f._4e_name()])if(!b&&!w.ie&&"br"==f._4e_name()&&!g)g=a;else return e;return a}}function n(a,b){function g(a){return a&&"span"==a.nodeName&&a.getAttribute("_ke_bookmark")}return function(c){var d,f;d=c&&!c.nodeName&&(f=c.parentNode)&&g(f);d=a?d:d||g(c);return b^d}}function p(a){return function(b){b=(b=b[0]||b)&&b.nodeType==d.NODE_TEXT&&!k.trim(b.nodeValue);return a^b}}var o=k.Editor;o.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,
ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var a=!0,e=!1,h=null,d=o.NODE,m=o.RANGE,x=o.POSITION,i=o.Walker,l=k.DOM,y=o.Utils.getByAddress,w=k.UA,f=o.XHTML_DTD,b=o.ElementPath,g=k.Node,c={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};s.prototype.toString=function(){var a=[];a.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);a.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return a.join("<br/>")};k.augment(s,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&l.equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=d.NODE_ELEMENT&&(b?b>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=d.NODE_ELEMENT&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):
this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&"span"==a._4e_name()&&a.attr("_ke_bookmark")&&this.setStartAt(a,m.POSITION_BEFORE_START);b&&"span"==b._4e_name()&&b.attr("_ke_bookmark")&&
this.setEndAt(b,m.POSITION_AFTER_END)},setStart:function(a,b){a[0].nodeType==d.NODE_ELEMENT&&c[a._4e_name()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||(this.endContainer=a,this.endOffset=b);this.updateCollapsed()},setEnd:function(a,b){a[0].nodeType==d.NODE_ELEMENT&&c[a._4e_name()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=b;this.startContainer||(this.startContainer=a,this.startOffset=b);this.updateCollapsed()},setStartAt:function(a,
b){switch(b){case m.POSITION_AFTER_START:this.setStart(a,0);break;case m.POSITION_BEFORE_END:a[0].nodeType==d.NODE_TEXT?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case m.POSITION_BEFORE_START:this.setStartBefore(a);break;case m.POSITION_AFTER_END:this.setStartAfter(a)}this.updateCollapsed()},setEndAt:function(a,b){switch(b){case m.POSITION_AFTER_START:this.setEnd(a,0);break;case m.POSITION_BEFORE_END:a[0].nodeType==d.NODE_TEXT?this.setEnd(a,a[0].nodeValue.length):
this.setEnd(a,a[0].childNodes.length);break;case m.POSITION_BEFORE_START:this.setEndBefore(a);break;case m.POSITION_AFTER_END:this.setEndAfter(a)}this.updateCollapsed()},execContentsAction:function(b,c){var f=this.startContainer,e=this.endContainer,i=this.startOffset,h=this.endOffset,v,j=this.document,k;this.optimizeBookmark();e[0].nodeType==d.NODE_TEXT?e=e._4e_splitText(h):0<e[0].childNodes.length&&(h>=e[0].childNodes.length?(e=new g(e[0].appendChild(j.createTextNode(""))),k=a):e=new g(e[0].childNodes[h]));
f[0].nodeType==d.NODE_TEXT?(f._4e_splitText(i),f.equals(e)&&(e=new g(f[0].nextSibling))):i?i>=f[0].childNodes.length?(v=new g(j.createTextNode("")),f.append(v),f=v,v=a):f=new g(f[0].childNodes[i].previousSibling):(v=new g(j.createTextNode("")),f.prepend(v),f=v,v=a);var i=f._4e_parents(),h=e._4e_parents(),m,u,q;for(m=0;m<i.length&&!(u=i[m],q=h[m],!u.equals(q));m++);for(var j=c,o,s,w,I=m;I<i.length;I++){o=i[I];s=j&&!o.equals(f)?j.appendChild(o.clone()[0]):null;for(o=o[0].nextSibling;o&&!l.equals(h[I],
o)&&!l.equals(e,o);)w=o.nextSibling,2==b?j.appendChild(o.cloneNode(a)):(l._4e_remove(o),1==b&&j.appendChild(o)),o=w;s&&(j=s)}for(j=c;m<h.length;m++){o=h[m];s=j&&0<b&&!o.equals(e)?j.appendChild(o.clone()[0]):null;if(!i[m]||!o.parent().equals(i[m].parent()))for(o=o[0].previousSibling;o&&!l.equals(i[m],o)&&!l.equals(f,o);)w=o.previousSibling,2==b?j.insertBefore(o.cloneNode(a),j.firstChild):(l._4e_remove(o),1==b&&j.insertBefore(o,j.firstChild)),o=w;s&&(j=s)}if(2==b){if(q=this.startContainer[0],q.nodeType==
d.NODE_TEXT&&q.nextSibling&&q.nextSibling.nodeType==d.NODE_TEXT&&(q.data+=q.nextSibling.data,q.parentNode.removeChild(q.nextSibling)),q=this.endContainer[0],q.nodeType==d.NODE_TEXT&&q.nextSibling&&q.nextSibling.nodeType==d.NODE_TEXT)q.data+=q.nextSibling.data,q.parentNode.removeChild(q.nextSibling)}else{if(u&&q&&(!f.parent().equals(u.parent())||!e.parent().equals(q.parent())))u=q._4e_index(),v&&q.parent().equals(f.parent())&&u--,this.setStart(q.parent(),u);this.collapse(a)}v&&f._4e_remove();k&&e[0].parentNode&&
e._4e_remove()},collapse:function(b){b?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=a},clone:function(){var a=new s(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=
d.NODE_ELEMENT||b.endContainer[0].nodeType!=d.NODE_ELEMENT)return h;var g=new o.Walker(b),c=n(a,void 0),f=p(a);b.evaluator=function(a){return f(a)&&c(a)};b=g.next();g.reset();g=g.previous();return b&&b.equals(g)?b:h},shrink:function(b,g){if(!this.collapsed){var b=b||m.SHRINK_TEXT,c=this.clone(),f=this.startContainer,h=this.endContainer,v=this.startOffset,j=this.endOffset,l=1,k=1;f&&f[0].nodeType==d.NODE_TEXT&&(v?v>=f[0].nodeValue.length?c.setStartAfter(f):(c.setStartBefore(f),l=0):c.setStartBefore(f));
h&&h[0].nodeType==d.NODE_TEXT&&(j?j>=h[0].nodeValue.length?c.setEndAfter(h):(c.setEndAfter(h),k=0):c.setEndBefore(h));c=new i(c);c.evaluator=function(a){a=a[0]||a;return a.nodeType==(b==m.SHRINK_ELEMENT?d.NODE_ELEMENT:d.NODE_TEXT)};var u;c.guard=function(g,c){g=g[0]||g;if(b==m.SHRINK_ELEMENT&&g.nodeType==d.NODE_TEXT||c&&g==u)return e;!c&&g.nodeType==d.NODE_ELEMENT&&(u=g);return a};l&&(f=c[b==m.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(f,g?m.POSITION_AFTER_START:m.POSITION_BEFORE_START);
k&&(c.reset(),(c=c[b==m.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(c,g?m.POSITION_BEFORE_END:m.POSITION_AFTER_END));return!(!l&&!k)}},createBookmark2:function(b){var c=this.startContainer,f=this.endContainer,e=this.startOffset,i=this.endOffset,v,j;if(!c||!f)return{start:0,end:0};if(b){if(c[0].nodeType==d.NODE_ELEMENT&&(v=new g(c[0].childNodes[e]))&&v[0]&&v[0].nodeType==d.NODE_TEXT&&0<e&&v[0].previousSibling.nodeType==d.NODE_TEXT)c=v,e=0;for(;c[0].nodeType==d.NODE_TEXT&&(j=c.prev())&&
j[0].nodeType==d.NODE_TEXT;)c=j,e+=j[0].nodeValue.length;if(!this.collapsed){if(f[0].nodeType==d.NODE_ELEMENT&&(v=new g(f[0].childNodes[i]))&&v[0]&&v[0].nodeType==d.NODE_TEXT&&0<i&&v[0].previousSibling.nodeType==d.NODE_TEXT)f=v,i=0;for(;f[0].nodeType==d.NODE_TEXT&&(j=f.prev())&&j[0].nodeType==d.NODE_TEXT;)f=j,i+=j[0].nodeValue.length}}return{start:c._4e_address(b),end:this.collapsed?h:f._4e_address(b),startOffset:e,endOffset:i,normalized:b,is2:a}},createBookmark:function(b){var c,f,d,e,i=this.collapsed;
c=new g("<span>",h,this.document);c.attr("_ke_bookmark",1);c.css("display","none");c.html("&nbsp;");b&&(d=k.guid("ke_bm_"),c.attr("id",d+"S"));i||(f=c.clone(),f.html("&nbsp;"),b&&f.attr("id",d+"E"),e=this.clone(),e.collapse(),e.insertNode(f));e=this.clone();e.collapse(a);e.insertNode(c);f?(this.setStartAfter(c),this.setEndBefore(f)):this.moveToPosition(c,m.POSITION_AFTER_END);return{startNode:b?d+"S":c,endNode:b?d+"E":f,serializable:b,collapsed:i}},moveToPosition:function(b,g){this.setStartAt(b,g);
this.collapse(a)},trim:function(b,g){var c=this.startContainer,f=this.startOffset,e=this.collapsed;if((!b||e)&&c[0]&&c[0].nodeType==d.NODE_TEXT){if(f)if(f>=c[0].nodeValue.length)f=c._4e_index()+1,c=c.parent();else{var i=c._4e_splitText(f),f=c._4e_index()+1,c=c.parent();l.equals(this.startContainer,this.endContainer)?this.setEnd(i,this.endOffset-this.startOffset):l.equals(c,this.endContainer)&&(this.endOffset+=1)}else f=c._4e_index(),c=c.parent();this.setStart(c,f);if(e){this.collapse(a);return}}c=
this.endContainer;f=this.endOffset;!g&&!e&&c[0]&&c[0].nodeType==d.NODE_TEXT&&(f?(f>=c.nodeValue.length||c._4e_splitText(f),f=c._4e_index()+1):f=c._4e_index(),c=c.parent(),this.setEnd(c,f))},insertNode:function(b){this.optimizeBookmark();this.trim(e,a);var g=this.startContainer;g[0].insertBefore(b[0]||b,g[0].childNodes[this.startOffset]||null);l.equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var g=y(this.document,b.start,b.normalized),
c=b.startOffset,f=b.end&&y(this.document,b.end,b.normalized),b=b.endOffset;this.setStart(g,c);f?this.setEnd(f,b):this.collapse(a)}else g=(c=b.serializable)?k.one("#"+b.startNode,this.document):b.startNode,b=c?k.one("#"+b.endNode,this.document):b.endNode,this.setStartBefore(g),g._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(a)},getCommonAncestor:function(a,b){var c=this.startContainer,f=this.endContainer,c=l.equals(c,f)?a&&c[0].nodeType==d.NODE_ELEMENT&&this.startOffset==
this.endOffset-1?new g(c[0].childNodes[this.startOffset]):c:c._4e_commonAncestor(f);return b&&c[0].nodeType==d.NODE_TEXT?c.parent():c},enlarge:function(b){switch(b){case m.ENLARGE_ELEMENT:if(this.collapsed)break;var b=this.getCommonAncestor(),c=new g(this.document.body),v,j,u,q,o,w=e,n,p;n=this.startContainer;p=this.startOffset;if(n[0].nodeType==d.NODE_TEXT){if(p&&(n=!k.trim(n[0].nodeValue.substring(0,p)).length&&n,w=!!n),n&&!(q=n[0].previousSibling))u=n.parent()}else p&&(q=n[0].childNodes[p-1]||
n[0].lastChild),q||(u=n);for(;u||q;){if(u&&!q){!o&&l.equals(u,b)&&(o=a);if(!c.contains(u))break;if(!w||"inline"!=u.css("display"))w=e,o?v=u:this.setStartBefore(u);q=u[0].previousSibling}for(;q;){n=e;if(q.nodeType==d.NODE_TEXT)p=q.nodeValue,/[^\s\ufeff]/.test(p)&&(q=h),n=/[\s\ufeff]$/.test(p);else if(0<q.offsetWidth&&!q.getAttribute("_ke_bookmark"))if(w&&f.$removeEmpty[q.nodeName.toLowerCase()]){p=l.text(q);if(/[^\s\ufeff]/.test(p))q=h;else for(var r=q.all||q.getElementsByTagName("*"),t=0,x;x=r[t++];)if(!f.$removeEmpty[x.nodeName.toLowerCase()]){q=
h;break}q&&(n=!!p.length)}else q=h;n&&(w?o?v=u:u&&this.setStartBefore(u):w=a);if(q){n=q.previousSibling;if(!u&&!n){u=new g(q);q=h;break}q=n}else u=h}u&&(u=u.parent())}n=this.endContainer;p=this.endOffset;u=q=h;o=w=e;if(n[0].nodeType==d.NODE_TEXT){if(n=!k.trim(n[0].nodeValue.substring(p)).length&&n,w=!(n&&n[0].nodeValue.length),n&&!(q=n[0].nextSibling))u=n.parent()}else(q=n[0].childNodes[p])||(u=n);for(;u||q;){if(u&&!q){!o&&l.equals(u,b)&&(o=a);if(!c.contains(u))break;if(!w||"inline"!=u.css("display"))w=
e,o?j=u:u&&this.setEndAfter(u);q=u[0].nextSibling}for(;q;){n=e;if(q.nodeType==d.NODE_TEXT)p=q.nodeValue,/[^\s\ufeff]/.test(p)&&(q=h),n=/^[\s\ufeff]/.test(p);else if(0<q.offsetWidth&&!q.getAttribute("_ke_bookmark"))if(w&&f.$removeEmpty[q.nodeName.toLowerCase()]){p=l.text(q);if(/[^\s\ufeff]/.test(p))q=h;else{r=q.all||q.getElementsByTagName("*");for(t=0;x=r[t++];)if(!f.$removeEmpty[x.nodeName.toLowerCase()]){q=h;break}}q&&(n=!!p.length)}else q=h;n&&w&&(o?j=u:this.setEndAfter(u));if(q){n=q.nextSibling;
if(!u&&!n){u=new g(q);q=h;break}q=n}else u=h}u&&(u=u.parent())}v&&j&&(b=v.contains(j)?j:v,this.setStartBefore(b),this.setEndAfter(b));break;case m.ENLARGE_BLOCK_CONTENTS:case m.ENLARGE_LIST_ITEM_CONTENTS:u=new s(this.document);c=new g(this.document.body);u.setStartAt(c,m.POSITION_AFTER_START);u.setEnd(this.startContainer,this.startOffset);u=new i(u);var y,J,I=i.blockBoundary(b==m.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:h),L=function(a){var b=I(a);b||(y=new g(a));return b};v=function(a){var b=L(a);!b&&"br"==
l._4e_name(a)&&(J=new g(a));return b};u.guard=L;u=u.lastBackward();y=y||c;this.setStartAt(y,"br"!=y._4e_name()&&(!u&&this.checkStartOfBlock()||u&&y.contains(u))?m.POSITION_AFTER_START:m.POSITION_AFTER_END);u=this.clone();u.collapse();u.setEndAt(c,m.POSITION_BEFORE_END);u=new i(u);u.guard=b==m.ENLARGE_LIST_ITEM_CONTENTS?v:L;y=h;u=u.lastForward();y=y||c;this.setEndAt(y,!u&&this.checkEndOfBlock()||u&&y.contains(u)?m.POSITION_BEFORE_END:m.POSITION_BEFORE_START);J&&this.setEndAfter(J)}},checkStartOfBlock:function(){var c=
this.startContainer,g=this.startOffset;if(g&&c[0].nodeType==d.NODE_TEXT&&k.trim(c[0].nodeValue.substring(0,g)).length)return e;this.trim();c=new b(this.startContainer);g=this.clone();g.collapse(a);g.setStartAt(c.block||c.blockLimit,m.POSITION_AFTER_START);c=new i(g);c.evaluator=j(a);return c.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,c=this.endOffset;if(a[0].nodeType==d.NODE_TEXT&&k.trim(a[0].nodeValue.substring(c)).length)return e;this.trim();a=new b(this.endContainer);c=
this.clone();c.collapse(e);c.setEndAt(a.block||a.blockLimit,m.POSITION_BEFORE_END);a=new i(c);a.evaluator=j(e);return a.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var a=this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,a);return a},checkBoundaryOfElement:function(a,b){var c=this.clone();c[b==m.START?"setStartAt":"setEndAt"](a,b==m.START?m.POSITION_AFTER_START:m.POSITION_BEFORE_END);c=new i(c);c.evaluator=
t;return c[b==m.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,c=this.endContainer,f=this.startOffset,e=this.endOffset,i;if(b[0].nodeType==d.NODE_ELEMENT)if(i=b[0].childNodes.length,i>f)b=new g(b[0].childNodes[f]);else if(1>i)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new g(b);b=b._4e_nextSourceNode()||b}if(c[0].nodeType==d.NODE_ELEMENT)if(i=c[0].childNodes.length,i>e)c=(new g(c[0].childNodes[e]))._4e_previousSourceNode(a);
else if(1>i)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new g(c)}b._4e_position(c)&x.POSITION_FOLLOWING&&(b=c);return{startNode:b,endNode:c}},fixBlock:function(a,b){var c=this.createBookmark(),f=new g(this.document.createElement(b));this.collapse(a);this.enlarge(m.ENLARGE_BLOCK_CONTENTS);f[0].appendChild(this.extractContents());f._4e_trim();w.ie||f._4e_appendBogus();this.insertNode(f);this.moveToBookmark(c);return f},splitBlock:function(c){var g=new b(this.startContainer),
f=new b(this.endContainer),d=g.block,i=f.block,v=h;if(!g.blockLimit.equals(f.blockLimit))return h;"br"!=c&&(d||(d=this.fixBlock(a,c),i=(new b(this.endContainer)).block),i||(i=this.fixBlock(e,c)));c=d&&this.checkStartOfBlock();g=i&&this.checkEndOfBlock();this.deleteContents();d&&l.equals(d,i)&&(g?(v=new b(this.startContainer),this.moveToPosition(i,m.POSITION_AFTER_END),i=h):c?(v=new b(this.startContainer),this.moveToPosition(d,m.POSITION_BEFORE_START),d=h):(i=this.splitElement(d),!w.ie&&!k.inArray(d._4e_name(),
["ul","ol"])&&d._4e_appendBogus()));return{previousBlock:d,nextBlock:i,wasStartOfBlock:c,wasEndOfBlock:g,elementPath:v}},splitElement:function(a){if(!this.collapsed)return h;this.setEndAt(a,m.POSITION_BEFORE_END);var b=this.extractContents(),c=a.clone(e);c[0].appendChild(b);c.insertAfter(a);this.moveToPosition(a,m.POSITION_AFTER_END);return c},moveToElementEditablePosition:function(b,c){var g,i=f;if(i.$empty[b._4e_name()])return e;for(;b&&b[0].nodeType==d.NODE_ELEMENT;){if(g=b._4e_isEditable())this.moveToPosition(b,
c?m.POSITION_BEFORE_END:m.POSITION_AFTER_START);else if(i.$inline[b._4e_name()])return this.moveToPosition(b,c?m.POSITION_AFTER_END:m.POSITION_BEFORE_START),a;if((b=i.$empty[b._4e_name()]?b[c?"prev":"next"](r):c?b.last(r):b.first(r))&&b[0].nodeType==d.NODE_TEXT)return this.moveToPosition(b,c?m.POSITION_AFTER_END:m.POSITION_BEFORE_START),a}return g},selectNodeContents:function(a){this.setStart(a,0);this.setEnd(a,a[0].nodeType==d.NODE_TEXT?a[0].nodeValue.length:a[0].childNodes.length)}});var v={abbr:1,
acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},u=new i.whitespaces,q=new i.bookmark;o.Utils.injectDom({_4e_breakParent:function(a,b){var c=o.Range,b=new g(b),c=new c(a.ownerDocument);c.setStartAfter(new g(a));c.setEndAfter(b);var f=c.extractContents();c.insertNode(new g(l._4e_remove(a)));a.parentNode.insertBefore(f,a.nextSibling)}});o.Range=s},{requires:["./base","./utils","./walker",
"./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(k){function s(a){this.document=a;this._={cache:{}};if(m){var g=this.getNative().createRange();if(!g||g.item&&g.item(0).ownerDocument!=a||g.parentElement&&g.parentElement().ownerDocument!=a)this.isInvalid=j}}function t(a){a=new s(a);return!a||a.isInvalid?n:a}var r=k.Editor;r.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var j=!0,n=null,p=k.UA,o=k.DOM,a=k.Node,e=r.SELECTION,h=r.RANGE,d=r.NODE,m=p.ie,x=r.Walker,i=r.Range,l={img:1,hr:1,li:1,
table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};k.augment(s,{getNative:!m?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=o._4e_getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!m?function(){var a=this._.cache;if(a.type)return a.type;var g=e.SELECTION_TEXT,c=this.getNative();if(c){if(1==c.rangeCount){var c=c.getRangeAt(0),
f=c.startContainer;f==c.endContainer&&f.nodeType==d.NODE_ELEMENT&&1==Number(c.endOffset-c.startOffset)&&l[f.childNodes[c.startOffset].nodeName.toLowerCase()]&&(g=e.SELECTION_ELEMENT)}}else g=e.SELECTION_NONE;return a.type=g}:function(){var a=this._.cache;if(a.type)return a.type;var g=e.SELECTION_NONE;try{var c=this.getNative(),f=c.type;"Text"==f&&(g=e.SELECTION_TEXT);"Control"==f&&(g=e.SELECTION_ELEMENT);c.createRange().parentElement&&(g=e.SELECTION_TEXT)}catch(d){}return a.type=g},getRanges:m?function(){var b=
function(a,b){a=a.duplicate();a.collapse(b);for(var f=a.parentElement(),e=f.childNodes,i,h=0;h<e.length;h++){var j=e[h];if(j.nodeType==d.NODE_ELEMENT){i=a.duplicate();i.moveToElementText(j);var j=i.compareEndPoints("StartToStart",a),l=i.compareEndPoints("EndToStart",a);i.collapse();if(0<j)break;else{if(!j||1==l&&-1==j)return{container:f,offset:h};if(!l)return{container:f,offset:h+1}}i=n}}i||(i=a.duplicate(),i.moveToElementText(f),i.collapse(!1));i.setEndPoint("StartToStart",a);i=(""+i.text).replace(/\r\n|\r/g,
"\n").length;try{for(;0<i;)i-=e[--h].nodeValue.length}catch(k){i=0}return 0===i?{container:f,offset:h}:{container:e[h],offset:-i}};return function(g){var c=this._.cache;if(c.ranges&&!g)return c.ranges;var f=this.getNative(),g=f&&f.createRange(),d=this.getType();if(!f)return[];if(d==e.SELECTION_TEXT)return f=new i(this.document),d=b(g,j),f.setStart(new a(d.container),d.offset),d=b(g),f.setEnd(new a(d.container),d.offset),c.ranges=[f];if(d==e.SELECTION_ELEMENT){c=c.ranges=[];for(d=0;d<g.length;d++){for(var h=
g.item(d),l=h.parentNode,k=0,f=new i(this.document);k<l.childNodes.length&&l.childNodes[k]!=h;k++);f.setStart(new a(l),k);f.setEnd(new a(l),k+1);c.push(f)}return c}return c.ranges=[]}}():function(b){var g=this._.cache;if(g.ranges&&!b)return g.ranges;var b=[],c=this.getNative();if(!c)return[];for(var f=0;f<c.rangeCount;f++){var d=c.getRangeAt(f),e=new i(this.document);e.setStart(new a(d.startContainer),d.startOffset);e.setEnd(new a(d.endContainer),d.endOffset);b.push(e)}return g.ranges=b},getStartElement:function(){var b=
this._.cache;if(void 0!==b.startElement)return b.startElement;var g,c=this.getNative();switch(this.getType()){case e.SELECTION_ELEMENT:return this.getSelectedElement();case e.SELECTION_TEXT:var f=this.getRanges()[0];if(f&&!f.collapsed){for(f.optimize();j;)if(g=f.startContainer,f.startOffset==(g[0].nodeType===d.NODE_ELEMENT?g[0].childNodes.length:g[0].nodeValue.length)&&!g._4e_isBlockBoundary())f.setStartAfter(g);else break;g=f.startContainer;if(g[0].nodeType!=d.NODE_ELEMENT)return g.parent();g=new a(g[0].childNodes[f.startOffset]);
if(!g[0]||g[0].nodeType!=d.NODE_ELEMENT)return f.startContainer;for(f=g[0].firstChild;f&&f.nodeType==d.NODE_ELEMENT;)g=new a(f),f=f.firstChild;return g}if(m)f=c.createRange(),f.collapse(j),g=new a(f.parentElement());else{if((g=c.anchorNode)&&g.nodeType!=d.NODE_ELEMENT)g=g.parentNode;g&&(g=new a(g))}}return b.startElement=g},getSelectedElement:function(){var b,f=this._.cache;if(void 0!==f.selectedElement)return f.selectedElement;m&&(b=this.getNative().createRange(),b=b.item&&b.item(0));if(!b){b=this.getRanges()[0];
for(var c,e,i=2;i&&(!(c=b.getEnclosedNode())||!(c[0].nodeType==d.NODE_ELEMENT&&l[c._4e_name()]&&(e=c)));i--)b.shrink(h.SHRINK_ELEMENT);b=e}return f.selectedElement=new a(b)},reset:function(){this._.cache={}},selectElement:function(a){var f,c=this.document;if(m)try{f=c.body.createControlRange(),f.addElement(a[0]),f.select()}catch(d){f=c.body.createTextRange(),f.moveToElementText(a[0]),f.select()}finally{}else f=c.createRange(),f.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(f);
this.reset()},selectRanges:function(a){if(m){if(1<a.length){var f=a[a.length-1];a[0].setEnd(f.endContainer,f.endOffset);a.length=1}a[0]&&a[0].select()}else{f=this.getNative();if(!f)return;f.removeAllRanges();for(var c=0;c<a.length;c++){var e=a[c],i=this.document.createRange(),h=e.startContainer;if(e.collapsed&&(p.gecko&&1.09>p.gecko||p.opera||p.webkit)&&h[0].nodeType==d.NODE_ELEMENT&&!h[0].childNodes.length)h[0].appendChild(this.document.createTextNode(p.webkit?"\u200b":"")),e.startOffset++,e.endOffset++;
i.setStart(h[0],e.startOffset);i.setEnd(e.endContainer[0],e.endOffset);f.addRange(i)}}this.reset()},createBookmarks2:function(a){for(var f=[],c=this.getRanges(),d=0;d<c.length;d++)f.push(c[d].createBookmark2(a));return f},createBookmarks:function(a,f){for(var c=[],d=this.document,e,f=f||this.getRanges(),i=f.length,h=0;h<i;h++){c.push(e=f[h].createBookmark(a,j));var l=(a=e.serializable)?k.one("#"+e.startNode,d):e.startNode;e=a?k.one("#"+e.endNode,d):e.endNode;for(var m=h+1;m<i;m++){var n=f[m],w=n.startContainer,
p=n.endContainer;o.equals(w,l.parent())&&n.startOffset++;o.equals(w,e.parent())&&n.startOffset++;o.equals(p,l.parent())&&n.endOffset++;o.equals(p,e.parent())&&n.endOffset++}}return c},selectBookmarks:function(a){for(var f=[],c=0;c<a.length;c++){var d=new i(this.document);d.moveToBookmark(a[c]);f.push(d)}this.selectRanges(f);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();
a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();m?a&&a.clear():a&&a.removeAllRanges()}});var y={table:1,tbody:1,tr:1},w=x.whitespaces(j),f=/\ufeff|\u00a0/;i.prototype.select=i.prototype.select=!m?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==d.NODE_ELEMENT&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var f=this.document.createRange();f.setStart(a[0],this.startOffset);try{f.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=
c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(j),f.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=t(this.document).getNative();a.removeAllRanges();a.addRange(f)}:function(b){var g=this.collapsed,c,e;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var i=this.startContainer[0].childNodes[this.startOffset];if(i.nodeType==d.NODE_ELEMENT){(new s(this.document)).selectElement(new a(i));return}}(this.startContainer[0].nodeType==d.NODE_ELEMENT&&
this.startContainer._4e_name()in y||this.endContainer[0].nodeType==d.NODE_ELEMENT&&this.endContainer._4e_name()in y)&&this.shrink(h.SHRINK_ELEMENT,j);var l=this.createBookmark(),i=l.startNode,k;g||(k=l.endNode);l=this.document.body.createTextRange();l.moveToElementText(i[0]);l.moveStart("character",1);if(k)b=this.document.body.createTextRange(),b.moveToElementText(k[0]),l.setEndPoint("EndToEnd",b),l.moveEnd("character",-1);else{for(c=i[0].nextSibling;c&&!w(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&
c.nodeValue.match(f))&&(b||!i[0].previousSibling||i[0].previousSibling&&"br"==o._4e_name(i[0].previousSibling));e=new a(this.document.createElement("span"));e.html("&#65279;");e.insertBefore(i);c&&o.insertBefore(this.document.createTextNode("\ufeff"),i[0]||i)}this.setStartBefore(i);i._4e_remove();if(g){if(c?(l.moveStart("character",-1),l.select(),this.document.selection.clear()):l.select(),e)this.moveToPosition(e,h.POSITION_BEFORE_START),e._4e_remove()}else this.setEndBefore(k),k._4e_remove(),l.select()};
s.getSelection=t;return r.Selection=s},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/plugin/selection/index",function(k,s){function t(d){function e(b,c){var f=g.body.createTextRange();try{f.moveToPoint(b,c)}catch(d){f=a}return f}function j(){var a=g.selection.createRange();c&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&c.select();h.remove(g,"mouseup",j);h.remove(g,"mousemove",k);c=f=0}function k(a){if(a.button){if(a=e(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",c)?a.setEndPoint("StartToStart",c):a.setEndPoint("EndToEnd",c),a.select()}else j()}var f,
b=d.get("iframe")[0].contentWindow,g=d.get("document")[0],c;h.on(g,"mousedown contextmenu",function(a){var d=g.documentElement;if(a.target===d&&(f&&j(),!(d.scrollHeight>d.clientHeight)&&(f=1,c=e(a.pageX,a.pageY))))h.on(g,"mouseup",j),h.on(g,"mousemove",k),b.focus(),c.select()})}function r(e){function h(a){if(g){var c=e.getSelection(),f=c&&c.getType(),d=c&&j.selection;if(a&&d&&f==m.SELECTION_NONE&&!j.queryCommandEnabled("InsertImage"))setTimeout(function(){h(p)},50);else{var k;if(!d||!d.type||!("Control"!=
d.type&&(k=d.createRange())&&(k=k.parentElement())&&(k=k.nodeName)&&k.toLowerCase()in{input:1,textarea:1}))b=d&&c.getRanges()[0],e._monitor()}}}var j=e.get("document")[0],k=new d(j.body),f=new d(j.documentElement);if(8>s.Utils.ieEngine)f.on("click",function(a){"html"===(new d(a.target))._4e_name()&&e.getSelection().getNative().createRange().select()});var b,g,c=p;f.on("mousedown",function(){c=o});f.on("mouseup",function(){c=p});k.on("focusin",function(f){if("body"==(new d(f.target))._4e_name()&&b){try{c&&
b.select()}catch(g){}b=a}});k.on("focus",function(){g=p;h()});k.on("beforedeactivate",function(a){a.relatedTarget||(g=o,c=p)});k.on("mousedown",function(){g=o});k.on("mouseup",function(){g=p;setTimeout(function(){h(p)},0)});k.on("keydown",function(){g=o});k.on("keyup",function(){g=p;setTimeout(function(){h()},0)})}function j(a){var d=a.get("document")[0];h.on(d,"mouseup keyup",function(){a._monitor()})}function n(a){function h(a){var b=s.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a._4e_name()]}
function j(a){return b(a)&&g(a)}var k=a.get("document")[0],f=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,b=s.Walker.whitespaces(p),g=s.Walker.bookmark(o,p),c=function(a){return b(a)&&8!=a.nodeType};a.on("selectionChange",function(b){var g=b.path,m=new d(a.get("document")[0].body),b=(b=b.selection)&&b.getRanges()[0],n=g.blockLimit;if(e.gecko){var r=g.block||g.blockLimit,t=r&&r.last(j);r&&r._4e_isBlockBoundary()&&
(!t||!(1==t[0].nodeType&&t._4e_isBlockBoundary()))&&"pre"!=r._4e_name()&&!r._4e_getBogus()&&r._4e_appendBogus()}if(b&&b.collapsed&&!g.block){if("body"==n._4e_name()){if((g=b.fixBlock(p,"p"))&&g[0]!=m[0].lastChild&&g._4e_outerHtml().match(f))if((n=g.next(c))&&n[0].nodeType==x.NODE_ELEMENT&&!h[n])b.moveToElementEditablePosition(n),g._4e_remove();else if((n=g.prev(c))&&n[0].nodeType==x.NODE_ELEMENT&&!h[n])b.moveToElementEditablePosition(n,n._4e_outerHtml().match(f)?o:p),g._4e_remove();b.select();a.notifySelectionChange()}g=
new s.Range(k);g.moveToElementEditablePosition(m,p);"body"!==(new s.ElementPath(g.startContainer)).blockLimit._4e_name()&&(m=(new d(k.createElement("p"))).appendTo(m),e.ie||m._4e_appendBogus())}})}var p=!0,o=!1,a=null,e=k.UA,h=k.Event,d=k.Node,m=s.SELECTION,x=s.NODE;return{init:function(a){a.docReady(function(){e.ie?(t(a),r(a)):j(a)});n(a)}}},{requires:["editor"]});
KISSY.add("editor/core/styles",function(k){function s(a){return!z.attr(a,"_ke_bookmark")}function t(a,b){for(var c in a)a.hasOwnProperty(c)&&(k.isString(a[c])?a[c]=a[c].replace(J,function(a,c){return b[c]}):t(a[c],b))}function r(a,b){b&&(a=k.clone(a),t(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#"==c||K[c]?C.STYLE_BLOCK:M[c]?C.STYLE_OBJECT:C.STYLE_INLINE;this._={definition:a}}function j(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var f=new O(a),g=f.getRanges(),d=0;d<g.length;d++)c.call(this,g[d]);f.selectRanges(g)}function n(a,b,c){var f=a.element;"*"==f&&(f="span");b=new F(b.createElement(f));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=r.getStyleText(c);if(a)for(var g in a)a.hasOwnProperty(g)&&b.attr(g,a[g]);c&&(b[0].style.cssText=c);return b}function p(b){var f=b.createBookmark(c),g=b.createIterator();g.enforceRealBlocks=c;g.enlargeBr=c;for(var d,i=b.document;d=g.getNextParagraph();){var h=n(this,i,
d),j=h,h="pre"==j._4e_name,k="pre"==d._4e_name,l=!h&&k;h&&!k?(k=d,l=k.html(),l=o(l,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),l=l.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),l=l.replace(/([ \t\n\r]+|&nbsp;)/g," "),l=l.replace(/<br\b[^>]*>/gi,"\n"),B.ie?(k=k[0].ownerDocument.createElement("div"),k.appendChild(j[0]),j[0].outerHTML="<pre>"+l+"</pre>",j=new F(k.firstChild),j._4e_remove()):j.html(l)):l?j=e(a(d),j):d._4e_moveChildren(j);d[0].parentNode.replaceChild(j[0],d[0]);if(h&&(d=j,h=void 0,(h=d._4e_previousSourceNode(c,
E.NODE_ELEMENT))&&"pre"==h._4e_name()))j=o(h.html(),/\n$/,"")+"\n\n"+o(d.html(),/^\n/,""),B.ie?d[0].outerHTML="<pre>"+j+"</pre>":d.html(j),h._4e_remove()}b.moveToBookmark(f)}function o(a,b,c){var f="",g="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(f=b);c&&(g=c);return""});return f+a.replace(b,c)+g}function a(a){var b=[];o(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function e(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),f=0;f<a.length;f++){var g=a[f],g=g.replace(/(\r\n|\r)/g,"\n"),g=o(g,/^[ \t]*\n/,""),g=o(g,/\n$/,""),g=o(g,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),g=g.replace(/\n/g,"<br>"),g=g.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
d=b.clone();d.html(g);c.appendChild(d[0])}return c}function h(a){var b=a.document;if(a.collapsed)b=n(this,b,void 0),a.insertNode(b),a.moveToPosition(b,G.POSITION_BEFORE_END);else{var f=this.element,g=this._.definition,d,e=D[f];e||(d=c,e=D.span);var i=a.createBookmark();a.enlarge(G.ENLARGE_ELEMENT);a.trim();for(var h=a.createBookmark(),j=h.startNode,h=h.endNode,k=j,l;k&&k[0];){var m=v;if(z.equals(k,h))k=u,m=c;else{var q=k[0].nodeType,o=q==E.NODE_ELEMENT?k._4e_name():u;if(o&&k.attr("_ke_bookmark")){k=
k._4e_nextSourceNode(c);continue}if(!o||e[o]&&(k._4e_position(h)|A.POSITION_PRECEDING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_PRECEDING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED&&(!g.childRule||g.childRule(k))){var p=k.parent();if(p&&"a"==f&&p._4e_name()==f)q=n(this,b,void 0),p._4e_moveChildren(q),p[0].parentNode.replaceChild(q[0],p[0]),q._4e_mergeSiblings();else if(p&&p[0]&&((D[p._4e_name()]||D.span)[f]||d)&&(!g.parentRule||g.parentRule(p))){if(!l&&(!o||!D.$removeEmpty[o]||(k._4e_position(h)|
A.POSITION_PRECEDING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_PRECEDING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED))l=new P(b),l.setStartBefore(k);if(q==E.NODE_TEXT||q==E.NODE_ELEMENT&&!k[0].childNodes.length){p=k;for(q=null;(m=!p.next(s))&&(q=p.parent())&&e[q._4e_name()]&&(q._4e_position(j)|A.POSITION_FOLLOWING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_FOLLOWING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED&&(!g.childRule||g.childRule(q));)p=q;l.setEndAfter(p)}}else m=
c}else m=c;k=k._4e_nextSourceNode()}if(m&&l&&!l.collapsed){for(var m=n(this,b,void 0),p=l.getCommonAncestor(),q={},o={},r,t=null,x;m&&p&&m[0]&&p[0];){if(p._4e_name()==f){for(r in g.attributes)if(g.attributes.hasOwnProperty(r)&&!o[r]&&(x=p.attr(t)))m.attr(r)==x?m.removeAttr(r):o[r]=1;for(t in g.styles)if(g.styles.hasOwnProperty(t)&&!q[t]&&(x=p.style(t)))m.style(t)==x?m.style(t,""):q[t]=1;if(!m._4e_hasAttributes()){m=u;break}}p=p.parent()}m?(m[0].appendChild(l.extractContents()),w(this,m),l.insertNode(m),
m._4e_mergeSiblings(),B.ie||m[0].normalize()):(m=new F(b.createElement("span")),m[0].appendChild(l.extractContents()),l.insertNode(m),w(this,m),m._4e_remove(!0));l=u}}j._4e_remove();h._4e_remove();a.moveToBookmark(i);a.shrink(G.SHRINK_TEXT)}}function d(a){a.enlarge(G.ENLARGE_ELEMENT);var b=a.createBookmark(),c=b.startNode;if(a.collapsed){for(var g=new H(c.parent()),d,e=0,h;e<g.elements.length&&(h=g.elements[e])&&!(h==g.block||h==g.blockLimit);e++)if(this.checkElementRemovable(h)){var j=a.checkBoundaryOfElement(h,
G.END),k=!j&&a.checkBoundaryOfElement(h,G.START);k||j?(d=h,d.match=k?"start":"end"):(h._4e_mergeSiblings(),h._4e_name()!=this.element?(j=i(this),f(h,j[h._4e_name()]||j["*"])):l(this,h))}if(d.length){h=c;for(e=0;;e++){j=g.elements[e];if(z.equals(j,d))break;else if(j.match)continue;else j=j.clone();j[0].appendChild(h[0]);h=j}h["start"==d.match?"insertBefore":"insertAfter"](d)}}else{var m=b.endNode,q=this,g=function(){for(var a=new H(c.parent()),b=new H(m.parent()),f=u,g=u,d=0;d<a.elements.length;d++){var e=
a.elements[d];if(e==a.block||e==a.blockLimit)break;q.checkElementRemovable(e)&&(f=e)}for(d=0;d<b.elements.length;d++){e=b.elements[d];if(e==b.block||e==b.blockLimit)break;q.checkElementRemovable(e)&&(g=e)}g&&m._4e_breakParent(g);f&&c._4e_breakParent(f)};g();for(d=new F(c[0].nextSibling);d[0]!==m[0];){e=d._4e_nextSourceNode();if(d[0]&&d[0].nodeType==E.NODE_ELEMENT&&this.checkElementRemovable(d)&&(d._4e_name()==this.element?l(this,d):(h=i(this),f(d,h[d._4e_name()]||h["*"])),e[0].nodeType==E.NODE_ELEMENT&&
e.contains(c)))g(),e=new F(c[0].nextSibling);d=e}}a.moveToBookmark(b)}function m(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,f){b[c]=f});return b}function x(a,b){var c="";b!==v?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function i(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;
if(c){k.isArray(c)||(c=[c]);for(var f=0;f<c.length;f++){var g=c[f],d,e,h;"string"==typeof g?d=g.toLowerCase():(d=g.element?g.element.toLowerCase():a.element,e=g.attributes,h=g.styles);g=b[d]||(b[d]={});if(e){d=g.attributes=g.attributes||[];for(var i in e)e.hasOwnProperty(i)&&d.push([i.toLowerCase(),e[i]])}if(h){var g=g.styles=g.styles||[],j;for(j in h)h.hasOwnProperty(j)&&g.push([j.toLowerCase(),h[j]])}}}return b}function l(a,f){var g=a._.definition,d=i(a),e=q.mix(g.attributes,(d[f._4e_name()]||d["*"]||
{}).attributes),g=q.mix(g.styles,(d[f._4e_name()]||d["*"]||{}).styles),d=k.isEmptyObject(e)&&k.isEmptyObject(g),h;for(h in e)if(e.hasOwnProperty(h)&&!(("class"==h||a._.definition.fullMatch)&&f.attr(h)!=y(h,e[h])))d=d||!!f.hasAttr(h),f.removeAttr(h);for(var j in g)g.hasOwnProperty(j)&&!(a._.definition.fullMatch&&f.style(j)!=y(j,g[j],c))&&(d=d||!!f.style(j),f.style(j,""));b(f)}function y(a,b,c){var f=new F("<span>");f[c?"style":"attr"](a,b);return f[c?"style":"attr"](a)}function w(a,b){for(var c=i(a),
g=b.all(a.element),d=g.length;0<=--d;)l(a,new F(g[d]));for(var e in c)if(c.hasOwnProperty(e)&&e!=a.element){g=b.all(e);for(d=g.length-1;0<=d;d--){var h=new F(g[d]);f(h,c[e])}}}function f(a,c){var f,g=c&&c.attributes;if(g)for(f=0;f<g.length;f++){var d=g[f][0],e;if(e=a.attr(d)){var h=g[f][1];(h===u||h.test&&h.test(e)||"string"==typeof h&&e==h)&&a[0].removeAttribute(d)}}if(g=c&&c.styles)for(f=0;f<g.length;f++)if(d=g[f][0],h=a.css(d)){var i=g[f][1];(i===u||i.test&&i.test(e)||"string"==typeof i&&h==i)&&
a.css(d,"")}b(a)}function b(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,f=a[0].lastChild;a._4e_remove(c);b&&(b.nodeType==E.NODE_ELEMENT&&z._4e_mergeSiblings(b),f&&b!=f&&f.nodeType==E.NODE_ELEMENT&&z._4e_mergeSiblings(f))}}var g=k.Editor,c=!0,v=!1,u=null,q=g.Utils,z=k.DOM,C={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},G=g.RANGE,O=g.Selection,E=g.NODE,A=g.POSITION,P=g.Range,F=k.Node,B=k.UA,H=g.ElementPath,K={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},D=g.XHTML_DTD,M={embed:1,
hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},N=/\s*(?:;\s*|$)/g,J=/#\((.+?)\)/g;g.STYLE=C;r.prototype={apply:function(a){j.call(this,a,v)},remove:function(a){j.call(this,a,c)},applyToRange:function(a){return(this.applyToRange=this.type==C.STYLE_INLINE?h:this.type==C.STYLE_BLOCK?p:u).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==C.STYLE_INLINE?d:u).call(this,a)},checkElementRemovable:function(a,b){if(!a)return v;var f=this._.definition,
g;if(a._4e_name()==this.element){if(!b&&!a._4e_hasAttributes())return c;var d=f._AC;if(d)f=d;else{var d={},e=0,h=f.attributes;if(h)for(var j in h)h.hasOwnProperty(j)&&(e++,d[j]=h[j]);if(h=r.getStyleText(f))d.style||e++,d.style=h;d._length=e;f=f._AC=d}if(f._length){for(var k in f)if("_length"!=k&&f.hasOwnProperty(k)){e=a.attr(k)||"";if("style"==k)a:{d=f[k];e=x(e,v);"string"==typeof d&&(d=m(d));"string"==typeof e&&(e=m(e));h=void 0;for(h in d)if(d.hasOwnProperty(h)&&!(h in e&&(e[h]==d[h]||"inherit"==
d[h]||"inherit"==e[h]))){d=v;break a}d=c}else d=f[k]==e;if(d){if(!b)return c}else if(b)return v}if(b)return c}else return c}k=i(this);if(k=k[a._4e_name()]||k["*"]){if(!(f=k.attributes)&&!(g=k.styles))return c;if(f)for(d=0;d<f.length;d++)if(k=f[d][0],k=a.attr(k))if(e=f[d][1],e===u||"string"==typeof e&&k==e||e.test&&e.test(k))return c;if(g)for(d=0;d<g.length;d++)if(k=a.css(g[d][0]))if(f=g[d][1],f===u||"string"==typeof f&&k==f||f.test&&f.test(k))return c}return v},checkActive:function(a){switch(this.type){case C.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,c);case C.STYLE_OBJECT:case C.STYLE_INLINE:for(var b=a.elements,f=0,g;f<b.length;f++)if(g=b[f],!(this.type==C.STYLE_INLINE&&(z.equals(g,a.block)||z.equals(g,a.blockLimit))))if((this.type!=C.STYLE_OBJECT||g._4e_name()in M)&&this.checkElementRemovable(g,c))return c}return v}};r.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,f=a.attributes&&a.attributes.style||"",c="";f.length&&(f=f.replace(N,";"));for(var g in b)if(b.hasOwnProperty(g)){var d=b[g],e=(g+":"+d).replace(N,
";");"inherit"==d?c+=e:f+=e}f.length&&(f=x(f));return a._ST=f+c};g.Style=r},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(k){var s=k.Editor,t=null,r=k.Node,j=k.DOM,n=k.UA,p=k.Event,o={debugUrl:function(a){a=a.replace(/-min\.(js|css)/i,".$1");k.Config.debug||(a=a.replace(/\.(js|css)/i,"-min.$1"));-1==a.indexOf("?t")&&(a=-1!=a.indexOf("?")?a+"&":a+"?",a+="t="+encodeURIComponent("20120502210130"));k.startsWith(a,"/")&&(a=a.substring(1));return s.Config.base+a},lazyRun:function(a,e,h){var d=a[e],j=a[h];a[e]=function(){d.apply(this,arguments);a[e]=a[h];return j.apply(this,arguments)}},
getXY:function(a,e,h,d){h=h.defaultView||h.parentWindow;a-=j.scrollLeft(h);e-=j.scrollTop(h);d&&(d=d.defaultView||d.parentWindow,h!=d&&h.frameElement&&(d=j.offset(h.frameElement,void 0,d),a+=d.left,e+=d.top));return{left:a,top:e}},tryThese:function(a){for(var e,h=0,d=arguments.length;h<d;h++){var j=arguments[h];try{e=j();break}catch(k){}}return e},arrayCompare:function(a,e){if(!a&&!e)return!0;if(!a||!e||a.length!=e.length)return!1;for(var h=0;h<a.length;h++)if(a[h]!==e[h])return!1;return!0},getByAddress:function(a,
e,h){for(var a=a.documentElement,d=0;a&&d<e.length;d++){var j=e[d];if(h)for(var k=-1,i=0;i<a.childNodes.length;i++){var l=a.childNodes[i];if(!(!0===h&&3==l.nodeType&&l.previousSibling&&3==l.previousSibling.nodeType)&&(k++,k==j)){a=l;break}}else a=a.childNodes[j]}return a?new r(a):t},clearAllMarkers:function(a){for(var e in a)a.hasOwnProperty(e)&&a[e]._4e_clearMarkers(a,!0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,"")},mix:function(a){for(var e={},h=
0;h<arguments.length;h++)e=k.mix(e,arguments[h]);return e},isCustomDomain:function(){if(!n.ie)return!1;var a=document.domain,e=window.location.hostname;return a!=e&&a!="["+e+"]"},isNumber:function(a){return/^\d+(.\d+)?$/.test(k.trim(a))},verifyInputs:function(a){for(var e=0;e<a.length;e++){var h=new r(a[e]),d=k.trim(o.valInput(h)),j=h.attr("data-verify"),h=h.attr("data-warning");if(j&&!RegExp(j).test(d))return alert(h),!1}return!0},sourceDisable:function(a,e){a.on("sourceMode",e.disable,e);a.on("wysiwygMode",
e.enable,e)},resetInput:function(a){var e=a.attr("placeholder");e&&n.ie?(a.addClass("ke-input-tip"),a.val(e)):n.ie||a.val("")},valInput:function(a,e){if(void 0===e)return a.hasClass("ke-input-tip")?"":a.val();a.removeClass("ke-input-tip");a.val(e)},placeholder:function(a,e){a.attr("placeholder",e);n.ie&&(a.on("blur",function(){k.trim(a.val())||(a.addClass("ke-input-tip"),a.val(e))}),a.on("focus",function(){a.removeClass("ke-input-tip");k.trim(a.val())==e&&a.val("")}))},htmlEncode:function(a){return!a?
a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(a){var a=k.clone(a),e;for(e in a)if(a.hasOwnProperty(e)){var h=a[e];k.isFunction(h)&&(a[e]=h())}return a},doFormUpload:function(a,e,h){function d(){var f={responseText:"",responseXML:t};f.argument=a?a.argument:t;try{var b;if((b=n.ie?r.contentWindow.document:r.contentDocument||window.frames[m].document)&&b.body)f.responseText=k.trim(j.text(b.body));f.responseXML=b&&b.XMLDocument?b.XMLDocument:
b}catch(g){}p.remove(r,"load",d);a.callback&&a.callback(f);setTimeout(function(){j._4e_remove(r)},100)}var m=k.guid("form-upload-"),r=document.createElement("iframe");r.id=m;r.name=m;r.className="ke-hidden";var i="document.open();"+(o.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";n.ie&&(r.src=n.ie?"javascript:void(function(){"+encodeURIComponent(i)+"}())":"");document.body.appendChild(r);n.ie&&(document.frames[m].name=m);var i=a.form,l={target:j.attr(i,"target"),
method:j.attr(i,"method"),encoding:j.attr(i,"encoding"),enctype:j.attr(i,"enctype"),action:j.attr(i,"action")};j.attr(i,{target:m,method:"post",enctype:"multipart/form-data",encoding:"multipart/form-data"});h&&j.attr(i,"action",h);var y;if(e){y=[];var e=s.Utils.normParams(e),w;for(w in e)e.hasOwnProperty(w)&&(h=document.createElement("input"),h.type="hidden",h.name=w,h.value=e[w],i.appendChild(h),y.push(h))}p.on(r,"load",d);i.submit();j.attr(i,l);if(y){e=0;for(w=y.length;e<w;e++)j._4e_remove(y[e])}return r},
map:function(a,e){for(var h=0;h<a.length;h++)a[h]=e(a[h]);return a},ieEngine:document.documentMode||n.ie,preventFocus:function(a){n.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(a){k.mix(j,a);for(var e in a)a.hasOwnProperty(e)&&function(e){r.prototype[e]=function(){var d=[].slice.call(arguments,0);d.unshift(this[0]);return(d=a[e].apply(t,d))&&(d.nodeType||k.isWindow(d))?new r(d):k.isArray(d)&&(d.__IS_NODELIST||d[0]&&d[0].nodeType)?new r(d):d}}(e)},addRes:function(){var a=
this.__res=this.__res||[];a.push.apply(a,k.makeArray(arguments))},destroyRes:function(){for(var a=this.__res||[],e=0;e<a.length;e++){var h=a[e];k.isFunction(h)?h():(h.destroy&&h.destroy(),h.remove&&h.remove())}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,function(a,h){return h.toUpperCase()})+"Active"}};return s.Utils=o},{requires:["./base"]});
KISSY.add("editor/core/walker",function(k,s){function t(a,f){if(this._.end)return o;var b,g=this.range,c,d=this.guard,i=this.type,j=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,g.trim(),g.collapsed))return this.end(),o;if(!a&&!this._.guardLTR){var k=g.endContainer,l=new m(k[0].childNodes[g.endOffset]);this._.guardLTR=function(a,b){return(!b||!k.equals(a))&&!h.equals(a,l)&&(a.nodeType!=e.NODE_ELEMENT||!b||"body"!=h._4e_name(a))}}if(a&&!this._.guardRTL){var r=g.startContainer,
s=0<g.startOffset&&new m(r[0].childNodes[g.startOffset-1]);this._.guardRTL=function(a,b){return(!b||!h.equals(a,r[0]))&&(!s||!h.equals(a,s[0]))&&(a.nodeType!=e.NODE_ELEMENT||!b||"body"!=h._4e_name(a))}}var t=a?this._.guardRTL:this._.guardLTR;c=d?function(a,b){return t(a,b)===p?p:d(a,b)}:t;this.current?b=this.current[j](p,i,c):a?(b=g.endContainer,0<g.endOffset?(b=new m(b[0].childNodes[g.endOffset-1]),c(b)===p&&(b=o)):b=c(b,n)===p?o:b._4e_previousSourceNode(n,i,c,void 0)):(b=g.startContainer,b=new m(b[0].childNodes[g.startOffset]),
b.length?c(b)===p&&(b=o):b=c(g.startContainer,n)===p?o:g.startContainer._4e_nextSourceNode(n,i,c,void 0));for(;b&&!this._.end;){this.current=b;if(!this.evaluator||this.evaluator(b)!==p){if(!f)return b}else if(f&&this.evaluator)return p;b=b[j](p,i,c)}this.end();return this.current=o}function r(a){for(var f,b=o;f=t.call(this,a);)b=f;return b}function j(a){this.range=a;this._={}}var n=!0,p=!1,o=null,a=k.UA,e=s.NODE,h=k.DOM,d=s.XHTML_DTD,m=k.Node;k.augment(j,{end:function(){this._.end=1},next:function(){return t.call(this)},
previous:function(){return t.call(this,n)},checkForward:function(){return t.call(this,p,n)!==p},checkBackward:function(){return t.call(this,n,n)!==p},lastForward:function(){return r.call(this)},lastBackward:function(){return r.call(this,n)},reset:function(){delete this.current;this._={}}});j.blockBoundary=function(a){return function(f){return!(f.nodeType==e.NODE_ELEMENT&&h._4e_isBlockBoundary(f,a))}};j.bookmark=function(a,f){function b(a){return"span"==h._4e_name(a)&&h.attr(a,"_ke_bookmark")}return function(g){var c,
d;c=g.nodeType==e.NODE_TEXT&&(d=g.parentNode)&&b(d);c=a?c:c||b(g);return f^c}};j.whitespaces=function(a){return function(f){f=f.nodeType==e.NODE_TEXT&&!k.trim(f.nodeValue);return a^f}};j.invisible=function(a){var f=j.whitespaces();return function(b){b=f(b)||b.nodeType==e.NODE_ELEMENT&&!b.offsetHeight;return a^b}};var x=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,i=j.whitespaces(),l=j.bookmark(),y=function(a){var f=h._4e_name(a);return l(a)||i(a)||1==a.nodeType&&f in d.$inline&&!(f in d.$empty)};j.getBogus=function(d){do d=
d._4e_previousSourceNode();while(y(d[0]));return d&&(!a.ie?"br"==d._4e_name():3==d[0].nodeType&&x.test(d.text()))?d:!1};s.Utils.injectDom({_4e_getBogus:function(a){return j.getBogus(new m(a))}});s.Walker=j},{requires:["./base","./utils","./dom"]});
KISSY.add("editor/core/zIndexManager",function(k){var s=k.Editor;s.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};s.baseZIndex=function(k){return(s.Config.baseZIndex||1E4)+k}},{requires:["./base"]});
KISSY.add("editor",function(k,s,t,r){function j(a,b){var g=a.body;i(function(){a.designMode="on";setTimeout(function(){a.designMode="off";g.focus();arguments.callee.retry||(arguments.callee.retry=n)},50)},function(){a.designMode="off";d.attr(g,"contentEditable",o);d.attr(g,"contentEditable",n);!b&&j(a,1)})}var n=!0,p=k.all,o=!1,a=document,e=k.UA,h=e.ie,d=k.DOM,m=k.Node,x=k.Event,i=t.tryThese,l="document.open();"+(t.isCustomDomain()?'document.domain="'+a.domain+'";':"")+"document.close();",y='<iframe style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+
(h?' src="javascript:void(function(){'+encodeURIComponent(l)+'}())"':"")+' allowTransparency="true"></iframe>';k.mix(s,{SOURCE_MODE:0,WYSIWYG_MODE:1});var w=s.WYSIWYG_MODE;k.augment(s,{createDom:function(){var a=this.get("textarea"),b;a||this.set("textarea",a=p("<textarea></textarea>"));b=this.get("el");b.addClass(this.get("prefixCls")+"editor-wrap",void 0);b.html('<div class="ke-editor-tools"></div><div class="ke-textarea-wrap"></div><div class=\'ke-editor-status\'></div>');this._UUID=k.guid();var d=
b.one(".ke-textarea-wrap");this.__set("iframeWrapEl",d);this.__set("toolBarEl",b.one(".ke-editor-tools"));this.__set("statusBarEl",b.one(".ke-editor-status"));var c=this.get("width"),e=this.get("height");b.css("width",c);a.css("width","100%");a.css("display","none");d.append(a);d.css("height",e);a.css("height",e);b.css("height","")},_uiSetHeight:function(a){this.get("iframeWrapEl").css("height",a);this.get("textarea").css("height",a)},_uiSetMode:function(a){var b=this.get("textarea");a?(this.execCommand("save"),
this._setData(b.val()),this.execCommand("save")):(b.val(this._getData(1,w)),b[0].focus());b[a?"hide":"show"]();this.get("iframe")[a?"show":"hide"]();this.fire((a?"wysiwyg":"source")+"Mode")},renderUI:function(){function a(){b.detach("docReady",a);if(b.get("focus"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,d=b.get("textarea");r.register(b);b.get("attachForm")&&d[0].form&&b._attachForm();b.on("docReady",a)},_createIframe:function(a){var b=this,d=new m(y),c=b.get("textarea");
c.hasAttr("tabindex")&&d.attr("tabIndex",e.webkit?-1:c.attr("tabIndex"));b.get("iframeWrapEl").prepend(d);b.set("iframe",d);b.__docReady=0;if(e.gecko&&!d.__loaded)d.on("load",function(){b._setUpIFrame(a)},b);else b._setUpIFrame(a)},destructor:function(){var a=this.get("el"),b=this.get("textarea"),d=this.get("document")[0],c=this.get("iframe")[0].contentWindow;this.sync();s.focusManager.remove(this);x.remove([d,d.documentElement,d.body,c]);k.each(this.__dialogs,function(a){a.destroy&&a.destroy()});
this.__commands=0;this.__editor_created_new||(b.insertBefore(a,void 0),b.css({width:this.get("width"),height:this.get("height")}),b.show())},_attachForm:function(){var a=this,b=a.get("textarea"),d=new m(b[0].form);d.on("submit",a.sync,a);a.on("destroy",function(){d.detach("submit",a.sync,a)})},addDialog:function(a,b){this.__dialogs[a]=b},showDialog:function(a,b){var d=this.__dialogs[a];d.show(b);this.fire("dialogShow",{dialog:d.dialog,pluginDialog:d,dialogName:a})},hasDialog:function(a){return!!this.__dialogs[a]},
addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],d=k.makeArray(arguments);d.shift();d.unshift(this);if(b)return b.exec.apply(b,d)},_clearIframeDocContent:function(){if(this.get("iframe")){var a=this.get("iframe"),b=a[0].contentWindow,d=this.get("document")[0];x.remove([d,d.documentElement,d.body,b]);a.remove()}},_getData:function(a,b){var d=this.htmlDataProcessor,c;void 0==b&&(b=this.get("mode"));c=b==
w?this.get("document")[0].body.innerHTML:d.toDataFormat(this.get("textarea").val());c=a?d.toHtml(c):d.toServer(c);c=k.trim(c);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(c)&&(c="");return c},_setData:function(a){var b,d=a;if(this.get("mode")!=w)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)d=b.toDataFormat(a,"p");this._clearIframeDocContent();this._createIframe(d)}},sync:function(){this.get("textarea").val(this._getData())},_getRawData:function(){return this.get("document")[0].body.innerHTML},
_setRawData:function(a){this.get("document")[0].body.innerHTML=a},_prepareIFrameHtml:function(d,b){var g=this.get("customStyle"),c=this.get("customLink"),e="",h=s.Utils.debugUrl("/theme/editor-iframe.css");if(c)for(var i=0;i<c.length;i++)e+='<link href="'+c[i]+'" rel="stylesheet"/>';return"<!doctype html><html><head>"+(8===a.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"")+"<title>${title}</title><link href='"+h+"' rel='stylesheet'/><style>"+(g||"")+"</style>"+e+"</head><body class='ke-editor'>"+
(b||"&nbsp;")+(d?'<script id="ke_actscript" type="text/javascript">'+(t.isCustomDomain()?'document.domain="'+a.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+d+'");<\/script>':"")+"</body></html>"},getSelection:function(){return s.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("document")[0],b=d._4e_getWin(a);e.ie||b&&b.parent&&b.parent.focus();b&&b.focus();a.body.focus();this.notifySelectionChange()},blur:function(){d._4e_getWin(this.get("document")[0]).blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a){var b=this.get("customStyle")||"",b=b+("\n"+a);this.set("customStyle",b);d.addStyleSheet(this.get("iframe")[0].contentWindow,b)},addCustomLink:function(a){var b=this.get("customLink")||[],d=this.get("document")[0];b.push(a);this.set("customLink",b);b=d.createElement("link");b.rel="stylesheet";d.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=this.get("document")[0],b=d.query("link",b),g=
0;g<b.length;g++)b[g].href==a&&d.remove(b[g]);b=this.get("customLink")||[];a=k.indexOf(a,b);-1!=a&&b.splice(a,1)},_setUpIFrame:function(a){function b(){j=i.document;d.__set("document",new m(j));d.__set("window",new m(i));c.detach();j.open("text/html","replace");j.write(e);j.close()}var d=this,c=d.get("iframe"),e=d._prepareIFrameHtml(d._UUID,a),i=c[0].contentWindow,j;c.__loaded=1;try{j=i.document}catch(k){if(c[0].src=c[0].src,7>h){setTimeout(b,10);return}}b()},docReady:function(a){this.on("docReady",
a);this.__docReady&&a.call(this)},_monitor:function(){var a=this;a._monitorId&&clearTimeout(a._monitorId);a._monitorId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var d=b.getStartElement(),c=new s.ElementPath(d);if(!a.__previousPath||!a.__previousPath.compare(c))a.__previousPath=c,a.fire("selectionChange",{selection:b,path:c,element:d})}},100)},notifySelectionChange:function(){this.__previousPath=null;this._monitor()},insertElement:function(a,b,d){var c=this;if(c.get("mode")===
w){c.focus();var e,h=a._4e_name(),i=s.XHTML_DTD,j=s.RANGE,k=s.NODE,l=i.$block[h],p=c.getSelection(),r=p&&p.getRanges(),t,x,y,B;if(!r||0==r.length){var H=arguments,K=H.callee;setTimeout(function(){K.apply(c,H)},30)}else{c.execCommand("save");for(var D=r.length-1;0<=D;D--){t=r[D];t.deleteContents();e=!D&&a||a.clone(n);b&&b(e);if(l)for(;(y=t.getCommonAncestor(o,n))&&(B=i[y._4e_name()])&&(!B||!B[h]);)y._4e_name()in i.span?t.splitElement(y):t.checkStartOfBlock()&&t.checkEndOfBlock()?(t.setStartBefore(y),
t.collapse(n),y.remove()):t.splitBlock();t.insertNode(e);x||(x=e)}x&&(h=x._4e_nextSourceNode(n),i=c.get("document")[0],B=s.XHTML_DTD,B.$inline[e._4e_name()]?(h=new m(i.createTextNode(" ")),h.insertAfter(x)):h?"br"==h._4e_name()&&B[h.parent()._4e_name()].p&&(B=new m("<p>&nbsp;</p>",null,i),h[0].parentNode.replaceChild(B[0],h[0]),h=B):(B=new m("<p>&nbsp;</p>",null,i),B.insertAfter(x),h=B),t.moveToPosition(x,j.POSITION_AFTER_END),h&&h[0].nodeType==k.NODE_ELEMENT&&t.moveToElementEditablePosition(h),p.selectRanges([t]),
c.focus(),e&&e.scrollIntoView(void 0,!1),c._saveLater(),d&&d(e))}}},insertHtml:function(a,b){var e=this,c;if(e.get("mode")===w){if(c=e.htmlDataProcessor)a=c.toDataFormat(a,null,b);e.focus();e.execCommand("save");var i=e.get("document")[0];c=0;if(h){var j=i.selection;"Control"==j.type&&j.clear();try{j.createRange().pasteHTML(a)}catch(k){}}else try{i.execCommand("inserthtml",o,a)}catch(l){setTimeout(function(){if(0==e.getSelection().getRanges().length){var b=new s.Range(i),c=d.first(i.body,function(a){return 1==
a.nodeType&&"br"!=d._4e_name(a)});c||(c=new m(i.createElement("p")),i.body.appendChild(c[0]));b.setStartAt(c,s.RANGE.POSITION_AFTER_START);b.select()}i.execCommand("inserthtml",o,a)},c=100)}setTimeout(function(){e.getSelection().scrollIntoView()},c);e._saveLater(c)}},_saveLater:function(a){var b=this;b.__saveTimer&&(clearTimeout(b.__saveTimer),b.__saveTimer=null);b.__saveTimer=setTimeout(function(){b.execCommand("save")},a||0)},_fixByBindIframeDoc:function(){var a=this,b=a.get("iframe"),d=a.get("textarea")[0],
b=b[0].contentWindow,c=a.get("document")[0];e.webkit&&(x.on(c,"click",function(a){var b=new m(a.target);k.inArray(b._4e_name(),["input","select"])&&a.preventDefault()}),x.on(c,"mouseup",function(a){var b=new m(a.target);k.inArray(b._4e_name(),["input","textarea"])&&a.preventDefault()}));if(e.gecko||h||e.opera){var i;i=(new m('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(d);i.on("focus",function(){a.focus()});a.activateGecko=function(){e.gecko&&
a.__iframeFocus&&i[0].focus()};a.on("destroy",function(){i.detach();i.remove()})}x.on(b,"focus",function(){e.gecko?j(c,o):e.opera&&c.body.focus();a.notifySelectionChange()});if(e.gecko)x.on(c,"mousedown",function(){a.__iframeFocus||j(c,o)});if(h&&(x.on(c,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.fire("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);a.fire("save");b.preventDefault()}}}),"CSS1Compat"==c.compatMode)){var l=
{33:1,34:1};x.on(c,"keydown",function(b){b.keyCode in l&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}if(e.webkit)x.on(c,"mousedown",function(b){b=new m(b.target);k.inArray(b._4e_name(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(e.gecko)x.on(c,"dragstart",function(a){var b=new m(a.target);b._4e_name()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});r.add(a)}});s._initIFrame=function(a){var b=r.getInstance(a),g=b.get("document")[0],
a=g.getElementById("ke_actscript");d.remove(a);b._fixByBindIframeDoc();var c=g.body;h?(c.hideFocus=n,c.disabled=n,c.contentEditable=n,c.removeAttribute("disabled")):setTimeout(function(){e.gecko||e.opera?c.contentEditable=n:e.webkit?c.parentNode.contentEditable=n:g.designMode="on"},0);if(e.gecko||e.opera){var i=g.documentElement;x.on(i,"mousedown",function(a){if(a.target==i){e.gecko&&j(g,o);b.activateGecko()}})}setTimeout(function(){h&&setTimeout(function(){if(g){c.runtimeStyle.marginBottom="0px";
c.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.__docReady=1;b.fire("docReady");var a=b.get("disableObjectResizing"),d=b.get("disableInlineTableEditing");if(a||d)try{g.execCommand("enableObjectResizing",o,!a);g.execCommand("enableInlineTableEditing",o,!d)}catch(e){x.on(c,h?"resizestart":"resize",function(b){var c=new m(b.target);(a||c._4e_name()==="table"&&d)&&b.preventDefault()})}},10)};return s},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/focusManager,editor/core/meta".split(",")});
